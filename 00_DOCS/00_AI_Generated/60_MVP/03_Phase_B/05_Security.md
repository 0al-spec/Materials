Вот расширенный и пояснённый раздел 6: Безопасность и изоляция, с акцентом на причины и последствия каждого шага -- особенно важно, так как мы работаем с вызовом системных команд от имени агентов:

⸻

6. Безопасность и изоляция

6.1. Реализуй контроль доступа к путям по caps из паспорта
	•	Извлекай список разрешённых шаблонов (caps.read, caps.write)
	•	При вызове MCP сравни args.path с шаблонами в allowlist
	•	Используй minimatch или path.startsWith с нормализацией
	•	При несоответствии -- верни 403 Forbidden
	•	Логируй попытки обхода (path traversal, доступ к /etc/passwd)

Пояснение:
Без чёткого контроля доступа агенты могут получить произвольный доступ к файловой системе, включая конфиденциальные данные. Система caps -- декларативный способ задать допустимые зоны ответственности агента. Она критична для sandbox-модели.

⸻

6.2. Добавь фильтр разрешённых бинарей (whitelist tools)
	•	Подготовь список допустимых системных утилит (cat, ls, ping)
	•	При чтении паспорта проверяй все cmd[0] на вхождение в список
	•	Откажи в загрузке YAML, если указан небезопасный бинарь (rm, curl, sudo)
	•	Сформируй лог: Blocked tool "curl" in agent "net"
	•	Поддержи конфигурационный файл allowed-tools.json или .env

Пояснение:
Даже если путь безопасен, команда может быть опасной. Whitelist бинарей гарантирует, что агент не может исполнять произвольные shell-команды, даже если они выглядят валидными. Это защита на уровне экосистемы, а не входных данных.

⸻

6.3. Оберни spawn в минимальную sandbox (без доступа к env/uid)
	•	Удали из spawn окружение по умолчанию (env: {})
	•	Укажи опцию uid/gid, если запуск от непривилегированного пользователя
	•	Ограничь доступ к stdin и закрой stdio: 'ignore', если не требуется
	•	Используй флаг shell: false и массив cmd + args напрямую
	•	Подготовь конфигурацию профиля (минимальный safe mode)

Пояснение:
Даже с whitelist, выполнение команд через spawn может привести к уязвимостям (например, через переменные окружения, интерактивные команды или побочные каналы). Минимизация окружения и отключение shell-режима -- базовые требования к безопасной среде.

⸻

6.4. Протестируй отказ на опасные команды (rm, shutdown)
	•	Создай YAML с командой rm -rf /tmp/test и проверь блокировку
	•	Попробуй вызвать shutdown через A2A и зафиксируй отказ
	•	Логируй попытки запрещённых операций и выводи предупреждение
	•	Убедись, что при ошибке не выполняется никакая часть команды
	•	Покрой edge-кейсы: команды с подстановками, shell injection, несуществующие пути

Пояснение:
Это ручной тест-контур, чтобы убедиться, что защита реально работает в боевых условиях. Важно протестировать не только happy-path, но и все потенциальные обходы -- от очевидных до тонких ошибок типа командной инъекции или wildcard-атак.

⸻

Вот дополнение к разделу 6, включающее подэтап 6.5, который описывает направления усиления безопасности через изоляцию на уровне ОС:

⸻

6.5. Подготовь архитектурный план расширения: seccomp, chroot, namespaces
	•	Составь список системных вызовов, необходимых агентам (read, write, execve, open)
	•	Определи потенциально опасные syscall’ы (mount, ptrace, reboot) и зафиксируй их для блокировки
	•	Изучи возможность применения seccomp-bpf профиля через внешние Node.js биндинги или shell-wrapper
	•	Исследуй возможность запуска команд в chroot-окружении или через unshare (user + mount namespace)
	•	Оцени переход на промежуточный sandbox-wrapper (например, запуск агента через отдельный процесс-обёртку с изоляцией)

Пояснение:
Этот шаг не обязателен для MVP, но он закладывает фундамент для перехода от декларативной безопасности к системной. Использование seccomp и chroot позволяет минимизировать ущерб даже при успешной атаке на YAML или MCP. Этот этап может стать основой для Enterprise-режима или AL-hardening профиля.

⸻

Если хочешь, могу в будущем составить отдельный Security Threat Model или чертёж Trust Boundary Diagram, чтобы оценить угрозы и зафиксировать цели sandbox’инга. 